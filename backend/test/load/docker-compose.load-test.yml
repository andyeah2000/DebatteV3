version: '3.8'

services:
  k6:
    image: grafana/k6:latest
    environment:
      - BASE_URL=http://api:4000/graphql
      - AUTH_TOKEN=${AUTH_TOKEN:-test-token}
      - K6_OUT=influxdb=http://influxdb:8086/k6
    volumes:
      - ./:/scripts
    command: run /scripts/rate-limit.k6.js
    networks:
      - load-test-network

  influxdb:
    image: influxdb:1.8
    environment:
      - INFLUXDB_DB=k6
      - INFLUXDB_HTTP_AUTH_ENABLED=false
    ports:
      - "8086:8086"
    networks:
      - load-test-network

  grafana:
    image: grafana/grafana:latest
    environment:
      - GF_AUTH_ANONYMOUS_ENABLED=true
      - GF_AUTH_ANONYMOUS_ORG_ROLE=Admin
    ports:
      - "3000:3000"
    volumes:
      - ./grafana/dashboards:/var/lib/grafana/dashboards
      - ./grafana/provisioning:/etc/grafana/provisioning
    networks:
      - load-test-network
    depends_on:
      - influxdb

  api:
    build:
      context: ../../
      dockerfile: Dockerfile
    environment:
      - NODE_ENV=test
      - PORT=4000
      - THROTTLE_TTL=60
      - THROTTLE_LIMIT=100
    ports:
      - "4000:4000"
    networks:
      - load-test-network
    depends_on:
      - redis
      - postgres

  redis:
    image: redis:alpine
    ports:
      - "6379:6379"
    networks:
      - load-test-network

  postgres:
    image: postgres:13-alpine
    environment:
      - POSTGRES_USER=test
      - POSTGRES_PASSWORD=test
      - POSTGRES_DB=debattle_test
    ports:
      - "5432:5432"
    networks:
      - load-test-network

networks:
  load-test-network:
    driver: bridge 